<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1B4332">
  <title>Agro Berry ‚Äî Traitement Phytosanitaire</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåø</text></svg>">
  <style>
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0}
    body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:#F8FAF5;overscroll-behavior:none}
    body.dark{background:#111;color:#e0e0e0}
    ::-webkit-scrollbar{width:4px;height:4px}
    ::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:4px}
    @keyframes slideDown{from{opacity:0;transform:translate(-50%,-20px)}to{opacity:1;transform:translate(-50%,0)}}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{opacity:0;transform:translateY(100%)}to{opacity:1;transform:translateY(0)}}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:0.35}}
    .blink{animation:blink 1.2s ease-in-out infinite}
    input,select,textarea,button{font-family:inherit}
    .photo-grid{display:flex;gap:4px;flex-wrap:wrap;margin-top:6px}
    .photo-grid img{width:60px;height:60px;object-fit:cover;border-radius:8px;cursor:pointer;border:2px solid #E5E7EB}
    .photo-grid img:hover{opacity:0.8}
    .photo-full{position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;cursor:pointer}
    .photo-full img{max-width:95%;max-height:90vh;border-radius:8px}
  </style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const{useState,useEffect,useRef,useMemo}=React;
const VER="2.1.0";
const SECTIONS={AG1:{name:"AG1",label:"HLS",fullName:"Myrtille Hors Sol",area:"3.00 ha",date:"Sept 2025",type:"hls",color:"#3B82F6",parcelles:[{id:"V13",area:"0.66 ha"},{id:"V14",area:"0.74 ha"},{id:"V15",area:"0.68 ha"},{id:"V16",area:"0.86 ha"},{id:"V9",area:"0.63 ha"},{id:"V6",area:"0.74 ha"}]},AG2:{name:"AG2",label:"HLS",fullName:"Myrtille Hors Sol",area:"2.60 ha",date:"Oct 2025",type:"hls",color:"#6366F1",parcelles:[{id:"V17",area:"0.91 ha"},{id:"V18",area:"1.00 ha"},{id:"V19",area:"0.70 ha"}]},AG3a:{name:"AG3",label:"HLS",fullName:"Myrtille HLS (2024)",area:"1.80 ha",date:"Juil 2024",type:"hls",color:"#8B5CF6",parcelles:[{id:"V3",area:"0.30 ha"},{id:"V5",area:"0.21 ha"},{id:"V6",area:"0.39 ha"},{id:"V12",area:"0.21 ha"},{id:"V8",area:"0.20 ha"},{id:"V9",area:"0.30 ha"}]},AG3b:{name:"AG3",label:"HLS",fullName:"Myrtille HLS (2023)",area:"2.00 ha",date:"Jan 2023",type:"hls",color:"#7C3AED",parcelles:[{id:"V10",area:"0.36 ha"},{id:"V11",area:"0.25 ha"},{id:"V16",area:"0.88 ha"},{id:"V17",area:"0.79 ha"}]},AG4:{name:"AG4",label:"S",fullName:"Myrtille Sol",area:"6.00 ha",date:"Jan 2023",type:"sol",color:"#DC2626",parcelles:[{id:"V1",area:"0.42 ha"},{id:"V2",area:"0.31 ha"},{id:"V4",area:"0.42 ha"},{id:"V5",area:"0.21 ha"},{id:"V7",area:"0.45 ha"},{id:"V12",area:"0.45 ha"},{id:"V13",area:"0.45 ha"},{id:"V15",area:"0.55 ha"},{id:"V19",area:"0.78 ha"},{id:"V20",area:"0.66 ha"},{id:"V21",area:"0.65 ha"},{id:"V18",area:"0.79 ha"}]},AG5:{name:"AG5",label:"S",fullName:"Myrtille Sol",area:"2.70 ha",date:"Oct 2011",type:"sol",color:"#E11D48",parcelles:[{id:"V5",area:"0.70 ha"},{id:"V6",area:"0.74 ha"},{id:"V9",area:"0.63 ha"},{id:"V10",area:"0.54 ha"},{id:"V11",area:"0.66 ha"}]},AG6:{name:"AG6",label:"S",fullName:"Myrtille Sol",area:"4.00 ha",date:"Avr 2013",type:"sol",color:"#EA580C",parcelles:[{id:"V31",area:"0.83 ha"},{id:"V32",area:"0.66 ha"},{id:"V33",area:"0.59 ha"},{id:"V34",area:"0.64 ha"},{id:"V35",area:"0.73 ha"},{id:"V36",area:"0.52 ha"}]},S1:{name:"S1",label:"F",fullName:"Fraise",area:"5.50 ha",date:"Oct 2025",type:"fraise",color:"#16A34A",parcelles:[{id:"V1",area:"0.68 ha"},{id:"V2",area:"0.37 ha"},{id:"V3",area:"0.72 ha"},{id:"V4",area:"0.80 ha"},{id:"V5",area:"0.75 ha"},{id:"V6",area:"0.29 ha"},{id:"V7",area:"0.87 ha"},{id:"V8",area:"0.76 ha"},{id:"V9",area:"0.26 ha"}]},S2:{name:"S2",label:"F",fullName:"Fraise",area:"6.60 ha",date:"Oct 2025",type:"fraise",color:"#059669",parcelles:[{id:"V10",area:"0.77 ha"},{id:"V11",area:"0.85 ha"},{id:"V12",area:"0.66 ha"},{id:"V13",area:"1.52 ha"},{id:"V14",area:"0.67 ha"},{id:"V15",area:"1.50 ha"},{id:"V16",area:"0.66 ha"},{id:"V17",area:"1.50 ha"},{id:"V18",area:"0.60 ha"}]},S3:{name:"S3",label:"F",fullName:"Fraise",area:"3.80 ha",date:"Oct 2025",type:"fraise",color:"#0D9488",parcelles:[{id:"V19",area:"1.00 ha"},{id:"V20",area:"0.70 ha"}]}};
const DIS_M=["Botrytis (Pourriture grise)","O√Ødium","Phytophthora","Anthracnose","Rouille","Moniliose","Septoriose","Alternaria","Acariens","Pucerons","Drosophila suzukii","Cochenilles","Thrips","N√©matodes","Chlorose ferrique","Carence magn√©sium"];
const DIS_F=["Botrytis (Pourriture grise)","O√Ødium","Phytophthora","Anthracnose","Verticilliose","Rhizoctone","Taches foliaires","Mildiou","Acariens","Pucerons","Thrips","Aleurodes","Limaces","N√©matodes","Chlorose ferrique","Carence calcium"];
const gid=()=>Date.now().toString(36)+Math.random().toString(36).substr(2);
const fD=d=>new Date(d).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"});
const fDT=d=>new Date(d).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
const fH=d=>new Date(d).toLocaleString("fr-FR",{hour:"2-digit",minute:"2-digit"});
const isToday=d=>{const t=new Date(),dd=new Date(d);return t.toDateString()===dd.toDateString()};
const isThisWeek=d=>{const now=new Date(),dd=new Date(d),diff=(now-dd)/(864e5);return diff>=0&&diff<7};
const timeAgo=d=>{const m=Math.floor((new Date()-new Date(d))/6e4);if(m<1)return"√† l'instant";if(m<60)return"il y a "+m+"min";const h=Math.floor(m/60);if(h<24)return"il y a "+h+"h";return"il y a "+Math.floor(h/24)+"j"};
const SC={Faible:{bg:"#FEF9C3",text:"#854D0E",border:"#FDE047"},Moyen:{bg:"#FED7AA",text:"#9A3412",border:"#FB923C"},Grave:{bg:"#FECACA",text:"#991B1B",border:"#F87171"}};
const stClr={clean:"#22C55E",faible:"#EAB308",moyen:"#F97316",grave:"#EF4444",resolved:"#94A3B8"};
const stBg={clean:"#fff",faible:"#FFFBEB",moyen:"#FFF7ED",grave:"#FEF2F2",resolved:"#F8FAFC"};
const stBdr={clean:"#E5E7EB",faible:"#FDE047",moyen:"#FB923C",grave:"#EF4444",resolved:"#CBD5E1"};
function ld(k,f){try{const d=localStorage.getItem("ab_"+k);return d?JSON.parse(d):f}catch{return f}}
function sv(k,d){localStorage.setItem("ab_"+k,JSON.stringify(d))}
(function(){const old=ld("records",[]);if(old.length>0&&ld("observations",null)===null){const obs=[],trt=[];old.forEach(r=>{const oid=gid();obs.push({id:oid,sk:r.sk,pid:r.pid,dis:r.dis,sev:r.sev,date:r.tdate||r.at,obsText:r.obs||"",zone:"",photos:[],res:r.res||false,resAt:r.resAt||null,by:r.by||"user",at:r.at});if(r.prod&&r.dose)trt.push({id:gid(),sk:r.sk,pid:r.pid,obsId:oid,prod:r.prod,dose:r.dose,tdate:r.tdate||r.at,dar:"",darEnd:"",notes:"",by:r.by||"user",at:r.at})});sv("observations",obs);sv("treatments",trt)}})();
async function ghSync(c,data){const ct=btoa(unescape(encodeURIComponent(JSON.stringify(data,null,2))));const u="https://api.github.com/repos/"+c.owner+"/"+c.repo+"/contents/data/phyto-data.json";let sha=null;try{const e=await fetch(u,{headers:{Authorization:"token "+c.token}});if(e.ok)sha=(await e.json()).sha}catch{}const b={message:"Sync phyto - "+new Date().toLocaleString("fr-FR"),content:ct};if(sha)b.sha=sha;return fetch(u,{method:"PUT",headers:{Authorization:"token "+c.token,"Content-Type":"application/json"},body:JSON.stringify(b)})}
async function ghRestore(c){const u="https://api.github.com/repos/"+c.owner+"/"+c.repo+"/contents/data/phyto-data.json";const r=await fetch(u,{headers:{Authorization:"token "+c.token}});if(r.ok){const f=await r.json();return JSON.parse(decodeURIComponent(escape(atob(f.content))))}return null}

// Photo component
function PhotoViewer({src,onClose}){return React.createElement("div",{className:"photo-full",onClick:onClose},React.createElement("img",{src,onClick:e=>e.stopPropagation()}))}
function PhotoGrid({photos,dark}){
  const[view,setView]=useState(null);
  if(!photos||!photos.length)return null;
  return React.createElement(React.Fragment,null,
    React.createElement("div",{className:"photo-grid"},photos.map((p,i)=>React.createElement("img",{key:i,src:p,onClick:()=>setView(p),style:{border:"2px solid "+(dark?"#444":"#E5E7EB")}}))),
    view&&React.createElement(PhotoViewer,{src:view,onClose:()=>setView(null)}));
}
function PhotoCapture({photos,setPhotos,dark,bd}){
  const ref=useRef();
  const add=e=>{const files=Array.from(e.target.files);files.forEach(f=>{const r=new FileReader();r.onload=ev=>{setPhotos(p=>[...p,ev.target.result])};r.readAsDataURL(f)})};
  const del=i=>setPhotos(p=>p.filter((_,j)=>j!==i));
  return React.createElement("div",null,
    React.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap",marginBottom:6}},
      photos.map((p,i)=>React.createElement("div",{key:i,style:{position:"relative"}},
        React.createElement("img",{src:p,style:{width:56,height:56,objectFit:"cover",borderRadius:8,border:"2px solid "+bd}}),
        React.createElement("button",{onClick:()=>del(i),style:{position:"absolute",top:-4,right:-4,width:18,height:18,borderRadius:"50%",background:"#EF4444",color:"#fff",border:"none",fontSize:10,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"}},"‚úï")))),
    React.createElement("button",{onClick:()=>ref.current.click(),style:{padding:"8px 14px",borderRadius:8,border:"2px dashed "+bd,background:"transparent",color:dark?"#9CA3AF":"#6B7280",fontSize:12,cursor:"pointer",width:"100%"}},"üì∑ Ajouter photo"+(photos.length?" ("+photos.length+")":"")),
    React.createElement("input",{ref,type:"file",accept:"image/*",capture:"environment",multiple:true,onChange:add,style:{display:"none"}}));
}

// Observation detail card (reusable, shows everything)
function ObsCard({r,treatments,sec,dark,cbg,ctx,stx,bd,onTog,onDel,showSection,compact}){
  const lt=treatments?treatments.filter(t=>t.obsId===r.id):[];
  const sevS=SC[r.sev]||{};
  return React.createElement("div",{style:{background:r.res?(dark?"#1A1A1A":"#F8FAFC"):(dark?sevS.bg+"22":sevS.bg||"#fff"),border:"1px solid "+(r.res?bd:sevS.border||bd),borderRadius:14,padding:compact?10:14,opacity:r.res?0.6:1,borderLeft:"4px solid "+(sec?.color||"#888")}},
    React.createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:6}},
      React.createElement("div",null,
        showSection&&React.createElement("div",{style:{fontSize:10,fontWeight:700,color:sec?.color,marginBottom:2}},sec?.name+" ‚Äî "+r.pid+" ‚Ä¢ "+sec?.fullName),
        React.createElement("span",{style:{fontWeight:700,fontSize:compact?13:15}},r.dis),
        React.createElement("span",{style:{marginLeft:6,fontSize:10,fontWeight:700,padding:"2px 8px",borderRadius:6,background:sevS.bg,color:sevS.text,border:"1px solid "+sevS.border}},r.sev),
        r.res&&React.createElement("span",{style:{marginLeft:4,fontSize:9,color:"#16A34A",fontWeight:700,background:"#DCFCE7",padding:"2px 6px",borderRadius:6}},"‚úì R√©solu")),
      React.createElement("span",{style:{fontSize:9,color:stx,whiteSpace:"nowrap",marginLeft:8}},timeAgo(r.at))),
    React.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:8,fontSize:11,color:stx,marginBottom:4}},
      React.createElement("span",null,"üìÖ "+fD(r.date)+" √† "+fH(r.at)),
      r.zone&&React.createElement("span",null,"üìê "+r.zone+"% touch√©")),
    r.obsText&&React.createElement("div",{style:{fontSize:12,padding:"6px 10px",background:dark?"#252525":"#F9FAFB",borderRadius:8,margin:"6px 0",borderLeft:"3px solid "+(sec?.color||"#888"),color:ctx}},"üìù "+r.obsText),
    React.createElement(PhotoGrid,{photos:r.photos||[],dark}),
    lt.length>0&&React.createElement("div",{style:{marginTop:8,padding:"8px 10px",background:dark?"#0A1A2E":"#EFF6FF",borderRadius:10,border:"1px solid "+(dark?"#1E3A5F":"#BFDBFE")}},
      React.createElement("div",{style:{fontSize:11,fontWeight:700,color:"#2563EB",marginBottom:4}},"üíä "+lt.length+" traitement"+(lt.length>1?"s":"")),
      lt.map(t=>{const da=t.darEnd&&new Date(t.darEnd)>new Date();return React.createElement("div",{key:t.id,style:{fontSize:11,color:stx,padding:"3px 0",display:"flex",justifyContent:"space-between"}},React.createElement("span",null,t.prod+" ‚Äî "+t.dose+" ("+fD(t.tdate)+")"),da&&React.createElement("span",{style:{color:"#EA580C",fontWeight:700,fontSize:10}},"‚è≥ DAR "+Math.ceil((new Date(t.darEnd)-new Date())/864e5)+"j"))})),
    (onTog||onDel)&&React.createElement("div",{style:{display:"flex",gap:6,marginTop:8}},
      onTog&&React.createElement("button",{onClick:()=>onTog(r.id),style:{flex:1,padding:7,borderRadius:8,border:"1px solid "+bd,background:r.res?"#FEF3C7":"#DCFCE7",fontSize:10,fontWeight:600,cursor:"pointer",color:r.res?"#92400E":"#166534"}},r.res?"‚Ü©Ô∏è R√©activer":"‚úÖ R√©solu"),
      onDel&&React.createElement("button",{onClick:()=>{if(confirm("Supprimer ?"))onDel(r.id)},style:{padding:"7px 10px",borderRadius:8,border:"1px solid #FECACA",background:"#FEF2F2",fontSize:10,fontWeight:600,cursor:"pointer",color:"#DC2626"}},"üóëÔ∏è")));
}

function App(){
  const[observations,setObs]=useState(()=>ld("observations",[]));
  const[treatments,setTrt]=useState(()=>ld("treatments",[]));
  const[page,setPage]=useState("dash");
  const[selP,setSelP]=useState(null);const[selS,setSelS]=useState(null);const[modalMode,setModalMode]=useState("surv");
  const[filter,setFilter]=useState("all");
  const[ghCfg,setGhCfg]=useState(()=>ld("ghcfg",{token:"",repo:"",owner:""}));
  const[syncSt,setSyncSt]=useState("");const[toast,setToast]=useState(null);
  const[dark,setDark]=useState(()=>ld("dark",false));const[search,setSearch]=useState("");
  useEffect(()=>{sv("observations",observations)},[observations]);
  useEffect(()=>{sv("treatments",treatments)},[treatments]);
  useEffect(()=>{sv("ghcfg",ghCfg)},[ghCfg]);
  useEffect(()=>{sv("dark",dark);document.body.classList.toggle("dark",dark)},[dark]);
  const t=(m,tp)=>{setToast({m,tp:tp||"ok"});setTimeout(()=>setToast(null),3000)};
  const sync=async()=>{if(!ghCfg.token||!ghCfg.repo||!ghCfg.owner){t("Config GitHub","err");return}setSyncSt("s");try{const r=await ghSync(ghCfg,{observations,treatments,at:new Date().toISOString(),v:VER});if(r.ok){setSyncSt("d");t("Synchronis√© ‚úì")}else{setSyncSt("e");t("Erreur","err")}}catch(e){setSyncSt("e");t(e.message,"err")}setTimeout(()=>setSyncSt(""),3000)};
  const restore=async()=>{if(!ghCfg.token||!ghCfg.repo||!ghCfg.owner){t("Config GitHub","err");return}setSyncSt("s");try{const d=await ghRestore(ghCfg);if(d){if(d.observations)setObs(d.observations);if(d.treatments)setTrt(d.treatments);setSyncSt("d");t("Restaur√© ‚úì")}else{setSyncSt("e");t("Rien","err")}}catch(e){setSyncSt("e");t(e.message,"err")}setTimeout(()=>setSyncSt(""),3000)};
  const getObsP=(sk,pid)=>observations.filter(r=>r.sk===sk&&r.pid===pid);
  const getObsPS=(sk,pid)=>{const r=getObsP(sk,pid);if(!r.length)return"clean";const a=r.filter(x=>!x.res);if(a.some(x=>x.sev==="Grave"))return"grave";if(a.some(x=>x.sev==="Moyen"))return"moyen";if(a.some(x=>x.sev==="Faible"))return"faible";return"resolved"};
  const getObsAC=(sk,pid)=>getObsP(sk,pid).filter(r=>!r.res).length;
  const getTrtP=(sk,pid)=>treatments.filter(r=>r.sk===sk&&r.pid===pid);
  const getTrtCount=(sk,pid)=>getTrtP(sk,pid).length;
  const getLastTrt=(sk,pid)=>{const tt=getTrtP(sk,pid);return tt.length?tt.reduce((a,b)=>new Date(a.tdate)>new Date(b.tdate)?a:b):null};
  const hasPendingDAR=(sk,pid)=>{const now=new Date();return getTrtP(sk,pid).some(tt=>tt.darEnd&&new Date(tt.darEnd)>now)};
  const addObs=r=>{setObs(p=>[{...r,id:gid(),by:"user",at:new Date().toISOString()},...p]);t("Observation ‚úì")};
  const delObs=id=>{setObs(p=>p.filter(r=>r.id!==id));t("Supprim√©")};
  const togObs=id=>{setObs(p=>p.map(r=>r.id===id?{...r,res:!r.res,resAt:!r.res?new Date().toISOString():null}:r))};
  const addTrt=r=>{setTrt(p=>[{...r,id:gid(),by:"user",at:new Date().toISOString()},...p]);t("Traitement ‚úì")};
  const delTrt=id=>{setTrt(p=>p.filter(r=>r.id!==id));t("Supprim√©")};
  const openModal=(sk,p,mode)=>{setSelS(sk);setSelP(p);setModalMode(mode)};
  const bg=dark?"#111":"#F8FAF5",cbg=dark?"#1E1E1E":"#fff",ctx=dark?"#E5E7EB":"#1F2937",stx=dark?"#9CA3AF":"#6B7280",bd=dark?"#333":"#E5E7EB";
  const th={bg,cbg,ctx,stx,bd,dark};

  return React.createElement("div",{style:{minHeight:"100vh",background:bg,color:ctx}},
    toast&&React.createElement("div",{style:{position:"fixed",top:20,left:"50%",transform:"translateX(-50%)",zIndex:9999,padding:"12px 24px",borderRadius:12,background:toast.tp==="err"?"#DC2626":"#16A34A",color:"#fff",fontWeight:600,fontSize:14,boxShadow:"0 8px 32px rgba(0,0,0,0.3)",animation:"slideDown 0.3s"}},toast.m),
    React.createElement("header",{style:{background:dark?"linear-gradient(135deg,#0D1B0F,#1A3A2A)":"linear-gradient(135deg,#1B4332,#2D6A4F)",padding:"12px 16px",display:"flex",alignItems:"center",justifyContent:"space-between"}},
      React.createElement("div",null,React.createElement("h1",{style:{color:"#fff",fontSize:16,fontWeight:800,margin:0}},"üåø AGRO BERRY"),React.createElement("p",{style:{color:"#A7F3D0",fontSize:10,margin:0}},"Traitement Phytosanitaire ‚Äî Ferme Zaouia")),
      React.createElement("div",{style:{display:"flex",gap:6,alignItems:"center"}},React.createElement("button",{onClick:()=>setDark(!dark),style:{background:"rgba(255,255,255,0.15)",border:"none",color:"#fff",padding:"6px 10px",borderRadius:8,fontSize:14,cursor:"pointer"}},dark?"‚òÄÔ∏è":"üåô"),React.createElement("span",{style:{color:"#A7F3D0",fontSize:10}},"v"+VER))),
    React.createElement("nav",{style:{display:"flex",background:cbg,borderBottom:"1px solid "+bd,overflow:"auto"}},
      [{k:"dash",l:"üìä Dashboard",ac:"#16A34A"},{k:"surv",l:"üîç Surveillance",ac:"#F59E0B"},{k:"trt",l:"üíä Traitement",ac:"#8B5CF6"},{k:"plan",l:"üèóÔ∏è Plan",ac:"#2D6A4F"},{k:"settings",l:"‚öôÔ∏è",ac:"#2D6A4F"}].map(tab=>
        React.createElement("button",{key:tab.k,onClick:()=>setPage(tab.k),style:{flex:tab.k==="settings"?"none":1,padding:"11px "+(tab.k==="settings"?"12px":"4px"),border:"none",borderBottom:page===tab.k?"3px solid "+tab.ac:"3px solid transparent",background:page===tab.k?(dark?"#1A3A2A":"#F0FDF4"):"transparent",color:page===tab.k?(dark?"#6EE7B7":"#1B4332"):stx,fontWeight:page===tab.k?700:500,fontSize:10,cursor:"pointer",whiteSpace:"nowrap"}},tab.l))),
    React.createElement("main",{style:{padding:10,maxWidth:1200,margin:"0 auto"}},
      page==="dash"&&React.createElement(Dashboard,{...th,observations,treatments,onOpenParcel:openModal}),
      page==="surv"&&React.createElement(SurvMap,{...th,observations,treatments,getPS:getObsPS,getAC:getObsAC,onSelect:(sk,p)=>openModal(sk,p,"surv"),search,setSearch,filter,setFilter}),
      page==="trt"&&React.createElement(TrtMap,{...th,observations,treatments,getTrtCount,getLastTrt,hasPendingDAR,getObsPS,getObsAC,onSelect:(sk,p)=>openModal(sk,p,"trt"),search,setSearch,filter,setFilter}),
      page==="plan"&&React.createElement(VisualPlan,{...th}),
      page==="settings"&&React.createElement(Settings,{...th,ghCfg,setGhCfg,sync,restore,syncSt,observations,treatments,setObs,setTrt,t})),
    selP&&selS&&React.createElement(ParcelModal,{...th,sec:SECTIONS[selS],sk:selS,par:selP,mode:modalMode,observations:getObsP(selS,selP.id),allObs:observations,treatments:getTrtP(selS,selP.id),onClose:()=>{setSelP(null);setSelS(null)},onAddObs:addObs,onDelObs:delObs,onTogObs:togObs,onAddTrt:addTrt,onDelTrt:delTrt,setMode:setModalMode}));
}

// ===== DASHBOARD =====
function Dashboard({bg,cbg,ctx,stx,bd,dark,observations,treatments,onOpenParcel}){
  const ao=observations.filter(r=>!r.res);
  const grave=ao.filter(r=>r.sev==="Grave");
  const untreated=ao.filter(o=>!treatments.some(t=>t.obsId===o.id));
  const todayObs=observations.filter(r=>isToday(r.at));
  const weekObs=observations.filter(r=>isThisWeek(r.at));
  const pendingDAR=treatments.filter(t=>t.darEnd&&new Date(t.darEnd)>new Date());

  // Section summary
  const secSummary=Object.entries(SECTIONS).map(([sk,sec])=>{
    const obs=observations.filter(r=>r.sk===sk&&!r.res);
    const g=obs.filter(r=>r.sev==="Grave").length;
    const m=obs.filter(r=>r.sev==="Moyen").length;
    const f=obs.filter(r=>r.sev==="Faible").length;
    const tc=treatments.filter(t=>t.sk===sk).length;
    return{sk,sec,total:obs.length,g,m,f,tc};
  }).filter(s=>s.total>0).sort((a,b)=>b.g-a.g||b.total-a.total);

  return React.createElement("div",null,
    // KPI row
    React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:6,marginBottom:12}},
      [{l:"Cas actifs",v:ao.length,i:"‚ö†Ô∏è",c:"#CA8A04",b:dark?"#2A2000":"#FEF9C3"},
       {l:"Graves",v:grave.length,i:"üî¥",c:"#DC2626",b:dark?"#2A0000":"#FEE2E2"},
       {l:"Non trait√©s",v:untreated.length,i:"üö®",c:"#EA580C",b:dark?"#2A1500":"#FFF7ED"},
       {l:"Aujourd'hui",v:todayObs.length,i:"üìã",c:"#2563EB",b:dark?"#001A2A":"#DBEAFE"}
      ].map((c,i)=>React.createElement("div",{key:i,style:{background:c.b,borderRadius:12,padding:"8px 4px",textAlign:"center"}},
        React.createElement("div",{style:{fontSize:14}},c.i),
        React.createElement("div",{style:{fontSize:20,fontWeight:800,color:c.c}},c.v),
        React.createElement("div",{style:{fontSize:8,color:c.c,fontWeight:600}},c.l)))),

    // ALERTES
    (grave.length>0||untreated.length>0||pendingDAR.length>0)&&React.createElement("div",{style:{marginBottom:14}},
      React.createElement("h3",{style:{fontSize:14,fontWeight:800,color:"#DC2626",marginBottom:8}},"üö® ALERTES"),
      grave.length>0&&React.createElement("div",{style:{background:dark?"#2A0000":"#FEF2F2",border:"1px solid "+(dark?"#5C0000":"#FECACA"),borderRadius:12,padding:10,marginBottom:6}},
        React.createElement("div",{style:{fontSize:12,fontWeight:700,color:"#DC2626",marginBottom:6}},"üî¥ "+grave.length+" cas GRAVE"+(grave.length>1?"S":"")),
        grave.slice(0,5).map(r=>{const sec=SECTIONS[r.sk];return React.createElement("div",{key:r.id,onClick:()=>{const p=sec.parcelles.find(p=>p.id===r.pid);if(p)onOpenParcel(r.sk,p,"surv")},style:{padding:"6px 8px",marginBottom:4,background:dark?"#3A0000":"#fff",borderRadius:8,cursor:"pointer",border:"1px solid "+(dark?"#5C0000":"#FECACA")}},
          React.createElement("div",{style:{display:"flex",justifyContent:"space-between"}},
            React.createElement("span",{style:{fontWeight:700,fontSize:12,color:sec?.color}},sec?.name+" ‚Äî "+r.pid),
            React.createElement("span",{style:{fontSize:9,color:stx}},timeAgo(r.at))),
          React.createElement("div",{style:{fontSize:12,fontWeight:600}},r.dis),
          r.zone&&React.createElement("span",{style:{fontSize:10,color:stx}}," ‚Ä¢ "+r.zone+"% touch√©"),
          r.obsText&&React.createElement("div",{style:{fontSize:10,color:stx,fontStyle:"italic",marginTop:2}},r.obsText),
          React.createElement(PhotoGrid,{photos:(r.photos||[]).slice(0,3),dark}))})),

      untreated.length>0&&React.createElement("div",{style:{background:dark?"#2A1500":"#FFF7ED",border:"1px solid "+(dark?"#5C3A00":"#FDBA74"),borderRadius:12,padding:10,marginBottom:6}},
        React.createElement("div",{style:{fontSize:12,fontWeight:700,color:"#EA580C",marginBottom:6}},"‚ö†Ô∏è "+untreated.length+" cas NON TRAIT√â"+(untreated.length>1?"S":"")),
        untreated.slice(0,5).map(r=>{const sec=SECTIONS[r.sk];return React.createElement("div",{key:r.id,onClick:()=>{const p=sec.parcelles.find(p=>p.id===r.pid);if(p)onOpenParcel(r.sk,p,"trt")},style:{padding:"5px 8px",marginBottom:3,background:dark?"#3A2500":"#fff",borderRadius:8,cursor:"pointer",border:"1px solid "+(dark?"#5C3A00":"#FDBA74"),display:"flex",justifyContent:"space-between",alignItems:"center"}},
          React.createElement("div",null,React.createElement("span",{style:{fontWeight:700,fontSize:11,color:sec?.color}},sec?.name+" ‚Äî "+r.pid),React.createElement("span",{style:{fontSize:11,marginLeft:6}},r.dis)),
          React.createElement("span",{style:{fontSize:9,fontWeight:700,padding:"2px 6px",borderRadius:6,background:(SC[r.sev]||{}).bg,color:(SC[r.sev]||{}).text}},r.sev))})),

      pendingDAR.length>0&&React.createElement("div",{style:{background:dark?"#1A0028":"#F3E8FF",border:"1px solid "+(dark?"#3D1F6B":"#DDD6FE"),borderRadius:12,padding:10}},
        React.createElement("div",{style:{fontSize:12,fontWeight:700,color:"#7C3AED",marginBottom:6}},"‚è≥ "+pendingDAR.length+" DAR actif"+(pendingDAR.length>1?"s":"")),
        pendingDAR.map(t=>{const sec=SECTIONS[t.sk];const dj=Math.ceil((new Date(t.darEnd)-new Date())/864e5);return React.createElement("div",{key:t.id,style:{display:"flex",justifyContent:"space-between",padding:"4px 8px",fontSize:11}},
          React.createElement("span",null,React.createElement("span",{style:{fontWeight:700,color:sec?.color}},sec?.name+" ‚Äî "+t.pid),React.createElement("span",{style:{color:stx}}," "+t.prod)),
          React.createElement("span",{style:{fontWeight:700,color:"#EA580C"}},dj+"j restant"+(dj>1?"s":"")))}))),

    // RESUME PAR SECTION
    secSummary.length>0&&React.createElement("div",{style:{marginBottom:14}},
      React.createElement("h3",{style:{fontSize:14,fontWeight:800,marginBottom:8}},"üìä R√©sum√© par section"),
      React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:6}},
        secSummary.map(s=>React.createElement("div",{key:s.sk,style:{background:cbg,borderRadius:12,padding:10,border:"1px solid "+bd,borderLeft:"4px solid "+s.sec.color,display:"flex",justifyContent:"space-between",alignItems:"center"}},
          React.createElement("div",null,
            React.createElement("span",{style:{fontWeight:700,fontSize:13,color:s.sec.color}},s.sec.name),
            React.createElement("span",{style:{fontSize:10,color:stx,marginLeft:6}},s.sec.fullName+" ‚Ä¢ "+s.sec.area)),
          React.createElement("div",{style:{display:"flex",gap:4}},
            s.g>0&&React.createElement("span",{className:"blink",style:{background:"#FEE2E2",color:"#991B1B",fontSize:9,fontWeight:700,padding:"3px 8px",borderRadius:8}},s.g+"üî¥"),
            s.m>0&&React.createElement("span",{style:{background:"#FED7AA",color:"#9A3412",fontSize:9,fontWeight:700,padding:"3px 8px",borderRadius:8}},s.m+"üü†"),
            s.f>0&&React.createElement("span",{style:{background:"#FEF9C3",color:"#854D0E",fontSize:9,fontWeight:700,padding:"3px 8px",borderRadius:8}},s.f+"üü°"),
            React.createElement("span",{style:{background:"#DBEAFE",color:"#1D4ED8",fontSize:9,fontWeight:700,padding:"3px 8px",borderRadius:8}},s.tc+"üíä")))))),

    // OBSERVATIONS DU JOUR / RECENTES
    React.createElement("div",{style:{marginBottom:14}},
      React.createElement("h3",{style:{fontSize:14,fontWeight:800,marginBottom:8}},todayObs.length>0?"üìã Observations d'aujourd'hui ("+todayObs.length+")":"üìã Observations r√©centes"),
      (todayObs.length>0?todayObs:weekObs.slice(0,10)).length===0?
        React.createElement("div",{style:{textAlign:"center",padding:30,color:stx,background:cbg,borderRadius:12,border:"1px solid "+bd}},React.createElement("div",{style:{fontSize:36}},"‚úÖ"),React.createElement("p",{style:{fontWeight:600,marginTop:6}},"Aucune observation r√©cente")):
      React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:8}},
        (todayObs.length>0?todayObs:weekObs.slice(0,10)).map(r=>React.createElement(ObsCard,{key:r.id,r,treatments,sec:SECTIONS[r.sk],dark,cbg,ctx,stx,bd,showSection:true,compact:false}))))
  );
}

// ===== SURVEILLANCE MAP =====
function SurvMap({bg,cbg,ctx,stx,bd,dark,observations,treatments,getPS,getAC,onSelect,search,setSearch,filter,setFilter}){
  const[exp,setExp]=useState(null);const ao=observations.filter(r=>!r.res);const gt=ao.filter(r=>r.sev==="Grave").length;const totalP=Object.values(SECTIONS).reduce((s,sec)=>s+sec.parcelles.length,0);
  const groups=[{title:"ü´ê Myrtille Hors Sol (HLS)",keys:["AG1","AG2","AG3a","AG3b"],type:"hls"},{title:"ü´ê Myrtille Sol",keys:["AG4","AG5","AG6"],type:"sol"},{title:"üçì Fraise",keys:["S1","S2","S3"],type:"fraise"}];
  const filteredGroups=filter==="all"?groups:groups.filter(g=>g.type===filter);
  const getSS=key=>{const sec=SECTIONS[key];let a=0,g=0;sec.parcelles.forEach(p=>{const r=observations.filter(r=>r.sk===key&&r.pid===p.id&&!r.res);a+=r.length;g+=r.filter(r=>r.sev==="Grave").length});return{a,g}};
  const dot=st=>React.createElement("span",{style:{display:"inline-block",width:8,height:8,borderRadius:"50%",background:stClr[st]||stClr.clean,marginRight:4}});
  const searchRes=useMemo(()=>{if(!search.trim())return null;const q=search.toLowerCase();const res=[];Object.entries(SECTIONS).forEach(([sk,sec])=>{sec.parcelles.forEach(p=>{if(p.id.toLowerCase().includes(q)||sec.name.toLowerCase().includes(q))res.push({sk,p,sec})})});return res},[search]);
  return React.createElement("div",null,
    React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:6,marginBottom:10}},
      [{l:"Parcelles",v:totalP,i:"üå±",c:"#16A34A",b:dark?"#0D2818":"#F0FDF4"},{l:"Cas Actifs",v:ao.length,i:"‚ö†Ô∏è",c:"#CA8A04",b:dark?"#2A2000":"#FEF9C3"},{l:"Graves",v:gt,i:"üî¥",c:"#DC2626",b:dark?"#2A0000":"#FEE2E2"}].map((c,i)=>React.createElement("div",{key:i,style:{background:c.b,borderRadius:12,padding:"10px 8px",textAlign:"center"}},React.createElement("div",{style:{fontSize:18}},c.i),React.createElement("div",{style:{fontSize:20,fontWeight:800,color:c.c}},c.v),React.createElement("div",{style:{fontSize:9,color:c.c,fontWeight:600}},c.l)))),
    React.createElement("div",{style:{position:"relative",marginBottom:8}},React.createElement("input",{value:search,onChange:e=>setSearch(e.target.value),placeholder:"üîç Rechercher parcelle...",style:{width:"100%",padding:"10px 14px",borderRadius:10,border:"2px solid "+bd,fontSize:13,outline:"none",background:cbg,color:ctx}}),search&&React.createElement("button",{onClick:()=>setSearch(""),style:{position:"absolute",right:8,top:"50%",transform:"translateY(-50%)",border:"none",background:"transparent",fontSize:16,cursor:"pointer",color:stx}},"‚úï")),
    searchRes&&searchRes.length>0&&React.createElement("div",{style:{background:cbg,border:"1px solid "+bd,borderRadius:12,padding:8,marginBottom:10,maxHeight:180,overflow:"auto"}},searchRes.map((r,i)=>{const st=getPS(r.sk,r.p.id);const ac=getAC(r.sk,r.p.id);return React.createElement("div",{key:i,onClick:()=>onSelect(r.sk,r.p),style:{display:"flex",justifyContent:"space-between",padding:"8px 10px",borderRadius:8,cursor:"pointer",marginBottom:3,background:dark?"#252525":"#F9FAFB",border:"1px solid "+bd}},React.createElement("div",null,React.createElement("span",{style:{fontWeight:700,fontSize:13,color:r.sec.color}},r.sec.name+" ‚Äî "+r.p.id),React.createElement("span",{style:{fontSize:11,color:stx,marginLeft:8}},r.p.area)),React.createElement("div",{style:{display:"flex",alignItems:"center",gap:4}},dot(st),ac>0&&React.createElement("span",{style:{background:"#FEF3C7",color:"#92400E",fontSize:9,fontWeight:700,padding:"1px 6px",borderRadius:8}},ac)))})),
    React.createElement("div",{style:{display:"flex",gap:4,marginBottom:8,flexWrap:"wrap"}},
      [{k:"all",l:"Tout"},{k:"hls",l:"ü´ê HLS"},{k:"sol",l:"ü´ê Sol"},{k:"fraise",l:"üçì Fraise"}].map(f=>React.createElement("button",{key:f.k,onClick:()=>setFilter(f.k),style:{padding:"5px 10px",borderRadius:16,border:filter===f.k?"2px solid #2D6A4F":"1px solid "+bd,background:filter===f.k?(dark?"#1A3A2A":"#F0FDF4"):cbg,color:filter===f.k?(dark?"#6EE7B7":"#2D6A4F"):stx,fontSize:10,fontWeight:600,cursor:"pointer"}},f.l))),
    filteredGroups.map((grp,gi)=>React.createElement("div",{key:gi,style:{marginBottom:14}},
      React.createElement("h3",{style:{fontSize:13,fontWeight:700,color:ctx,marginBottom:6,padding:"7px 10px",background:cbg,borderRadius:10,border:"1px solid "+bd}},grp.title),
      React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(2,1fr)",gap:6}},grp.keys.map(key=>{const sec=SECTIONS[key];const ss=getSS(key);const isExp=exp===key;
        return React.createElement("div",{key,style:{gridColumn:isExp?"1/-1":"auto"}},React.createElement("div",{onClick:()=>setExp(isExp?null:key),style:{background:cbg,borderRadius:12,border:"2px solid "+sec.color+"22",overflow:"hidden",cursor:"pointer"}},
          React.createElement("div",{style:{background:"linear-gradient(135deg,"+sec.color+","+sec.color+"DD)",padding:"9px 10px",display:"flex",justifyContent:"space-between",alignItems:"center"}},React.createElement("div",null,React.createElement("span",{style:{color:"#fff",fontWeight:800,fontSize:13}},sec.name),React.createElement("span",{style:{color:"rgba(255,255,255,0.8)",fontSize:10,marginLeft:5}},"("+sec.label+")")),React.createElement("span",{style:{color:"#fff",fontSize:10,fontWeight:600}},sec.area)),
          React.createElement("div",{style:{padding:"6px 10px",display:"flex",justifyContent:"space-between",alignItems:"center"}},React.createElement("span",{style:{fontSize:10,color:stx}},sec.parcelles.length+" parc. ‚Ä¢ "+sec.date),React.createElement("div",{style:{display:"flex",gap:4}},ss.a>0&&React.createElement("span",{style:{background:"#FEF3C7",color:"#92400E",fontSize:9,fontWeight:700,padding:"2px 7px",borderRadius:8}},ss.a+" cas"),ss.g>0&&React.createElement("span",{className:"blink",style:{background:"#FEE2E2",color:"#991B1B",fontSize:9,fontWeight:700,padding:"2px 7px",borderRadius:8}},ss.g+" grave"),ss.a===0&&React.createElement("span",{style:{background:"#DCFCE7",color:"#166534",fontSize:9,fontWeight:700,padding:"2px 7px",borderRadius:8}},"‚úì")))),
        isExp&&React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:5,marginTop:6,animation:"fadeIn 0.3s"}},sec.parcelles.map(p=>{const st=getPS(key,p.id);const ac=getAC(key,p.id);
          return React.createElement("div",{key:p.id,onClick:e=>{e.stopPropagation();onSelect(key,p)},className:st==="grave"?"blink":"",style:{background:dark?(st==="grave"?"#2A0000":"#1E1E1E"):stBg[st],border:"2px solid "+stBdr[st],borderRadius:10,padding:"9px 6px",textAlign:"center",cursor:"pointer",position:"relative"}},
            ac>0&&React.createElement("div",{style:{position:"absolute",top:-4,right:-4,background:"#EF4444",color:"#fff",fontSize:8,fontWeight:800,width:16,height:16,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",zIndex:2}},ac),
            React.createElement("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",gap:3}},dot(st),React.createElement("span",{style:{fontWeight:700,fontSize:12,color:ctx}},p.id)),React.createElement("div",{style:{fontSize:9,color:stx,marginTop:2}},p.area))})))})))),
    React.createElement("div",{style:{background:cbg,borderRadius:10,padding:8,marginTop:8,border:"1px solid "+bd}},React.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:8}},
      [{l:"Sain",c:"#22C55E"},{l:"Faible",c:"#EAB308"},{l:"Moyen",c:"#F97316"},{l:"Grave",c:"#EF4444"},{l:"R√©solu",c:"#94A3B8"}].map(x=>React.createElement("div",{key:x.l,style:{display:"flex",alignItems:"center",gap:3}},React.createElement("span",{style:{width:8,height:8,borderRadius:"50%",background:x.c}}),React.createElement("span",{style:{fontSize:9,color:stx}},x.l))))));
}

// TRAITEMENT MAP
function TrtMap({bg,cbg,ctx,stx,bd,dark,observations,treatments,getTrtCount,getLastTrt,hasPendingDAR,getObsPS,getObsAC,onSelect,search,setSearch,filter,setFilter}){
  const[exp,setExp]=useState(null);const totalTrt=treatments.length;const pendingDAR=treatments.filter(t=>t.darEnd&&new Date(t.darEnd)>new Date()).length;const untreated=observations.filter(o=>!o.res&&!treatments.some(t=>t.obsId===o.id)).length;
  const groups=[{title:"ü´ê Myrtille HLS",keys:["AG1","AG2","AG3a","AG3b"],type:"hls"},{title:"ü´ê Myrtille Sol",keys:["AG4","AG5","AG6"],type:"sol"},{title:"üçì Fraise",keys:["S1","S2","S3"],type:"fraise"}];
  const filteredGroups=filter==="all"?groups:groups.filter(g=>g.type===filter);
  const getTrtSS=key=>{const sec=SECTIONS[key];let tc=0,dar=0;sec.parcelles.forEach(p=>{tc+=treatments.filter(t=>t.sk===key&&t.pid===p.id).length;dar+=treatments.filter(t=>t.sk===key&&t.pid===p.id&&t.darEnd&&new Date(t.darEnd)>new Date()).length});return{tc,dar}};
  const trtClr={clean:"#22C55E",treated:"#3B82F6",needs:"#EF4444",watch:"#EAB308",dar:"#F97316"};
  const trtBg2={clean:"#fff",treated:dark?"#0A1A2E":"#EFF6FF",needs:dark?"#2A0000":"#FEF2F2",watch:dark?"#2A2000":"#FFFBEB",dar:dark?"#2A1500":"#FFF7ED"};
  const trtBdr2={clean:"#E5E7EB",treated:"#93C5FD",needs:"#F87171",watch:"#FDE047",dar:"#FB923C"};
  const getPSt=(sk,pid)=>{const hd=hasPendingDAR(sk,pid);const os=getObsPS(sk,pid);const tc=getTrtCount(sk,pid);if(hd)return"dar";if(os==="grave"||os==="moyen")return tc>0?"treated":"needs";if(os==="faible")return tc>0?"treated":"watch";return tc>0?"treated":"clean"};
  return React.createElement("div",null,
    React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:6,marginBottom:10}},
      [{l:"Traitements",v:totalTrt,i:"üíä",c:"#7C3AED",b:dark?"#1A0028":"#F3E8FF"},{l:"Non trait√©s",v:untreated,i:"‚ö†Ô∏è",c:"#DC2626",b:dark?"#2A0000":"#FEE2E2"},{l:"DAR actif",v:pendingDAR,i:"‚è≥",c:"#EA580C",b:dark?"#2A1500":"#FFF7ED"}].map((c,i)=>React.createElement("div",{key:i,style:{background:c.b,borderRadius:12,padding:"10px 8px",textAlign:"center"}},React.createElement("div",{style:{fontSize:18}},c.i),React.createElement("div",{style:{fontSize:20,fontWeight:800,color:c.c}},c.v),React.createElement("div",{style:{fontSize:9,color:c.c,fontWeight:600}},c.l)))),
    React.createElement("div",{style:{position:"relative",marginBottom:8}},React.createElement("input",{value:search,onChange:e=>setSearch(e.target.value),placeholder:"üîç Rechercher...",style:{width:"100%",padding:"10px 14px",borderRadius:10,border:"2px solid "+bd,fontSize:13,outline:"none",background:cbg,color:ctx}}),search&&React.createElement("button",{onClick:()=>setSearch(""),style:{position:"absolute",right:8,top:"50%",transform:"translateY(-50%)",border:"none",background:"transparent",fontSize:16,cursor:"pointer",color:stx}},"‚úï")),
    React.createElement("div",{style:{display:"flex",gap:4,marginBottom:8,flexWrap:"wrap"}},
      [{k:"all",l:"Tout"},{k:"hls",l:"ü´ê HLS"},{k:"sol",l:"ü´ê Sol"},{k:"fraise",l:"üçì Fraise"}].map(f=>React.createElement("button",{key:f.k,onClick:()=>setFilter(f.k),style:{padding:"5px 10px",borderRadius:16,border:filter===f.k?"2px solid #7C3AED":"1px solid "+bd,background:filter===f.k?(dark?"#1A0028":"#F3E8FF"):cbg,color:filter===f.k?(dark?"#C4B5FD":"#6D28D9"):stx,fontSize:10,fontWeight:600,cursor:"pointer"}},f.l))),
    filteredGroups.map((grp,gi)=>React.createElement("div",{key:gi,style:{marginBottom:14}},
      React.createElement("h3",{style:{fontSize:13,fontWeight:700,color:ctx,marginBottom:6,padding:"7px 10px",background:cbg,borderRadius:10,border:"1px solid "+bd}},grp.title),
      React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(2,1fr)",gap:6}},grp.keys.map(key=>{const sec=SECTIONS[key];const ss=getTrtSS(key);const isExp=exp===key;
        return React.createElement("div",{key,style:{gridColumn:isExp?"1/-1":"auto"}},React.createElement("div",{onClick:()=>setExp(isExp?null:key),style:{background:cbg,borderRadius:12,border:"2px solid "+sec.color+"22",overflow:"hidden",cursor:"pointer"}},
          React.createElement("div",{style:{background:"linear-gradient(135deg,"+sec.color+","+sec.color+"DD)",padding:"9px 10px",display:"flex",justifyContent:"space-between",alignItems:"center"}},React.createElement("div",null,React.createElement("span",{style:{color:"#fff",fontWeight:800,fontSize:13}},sec.name),React.createElement("span",{style:{color:"rgba(255,255,255,0.8)",fontSize:10,marginLeft:5}},"("+sec.label+")")),React.createElement("span",{style:{color:"#fff",fontSize:10,fontWeight:600}},sec.area)),
          React.createElement("div",{style:{padding:"6px 10px",display:"flex",justifyContent:"space-between",alignItems:"center"}},React.createElement("span",{style:{fontSize:10,color:stx}},sec.parcelles.length+" parc."),React.createElement("div",{style:{display:"flex",gap:4}},ss.tc>0&&React.createElement("span",{style:{background:"#DBEAFE",color:"#1D4ED8",fontSize:9,fontWeight:700,padding:"2px 7px",borderRadius:8}},ss.tc+" trt"),ss.dar>0&&React.createElement("span",{className:"blink",style:{background:"#FFF7ED",color:"#C2410C",fontSize:9,fontWeight:700,padding:"2px 7px",borderRadius:8}},"‚è≥"+ss.dar)))),
        isExp&&React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:5,marginTop:6,animation:"fadeIn 0.3s"}},sec.parcelles.map(p=>{const ps=getPSt(key,p.id);const tc=getTrtCount(key,p.id);const lt=getLastTrt(key,p.id);
          return React.createElement("div",{key:p.id,onClick:e=>{e.stopPropagation();onSelect(key,p)},className:ps==="dar"?"blink":"",style:{background:dark?"#1E1E1E":trtBg2[ps],border:"2px solid "+trtBdr2[ps],borderRadius:10,padding:"9px 6px",textAlign:"center",cursor:"pointer",position:"relative"}},
            tc>0&&React.createElement("div",{style:{position:"absolute",top:-4,right:-4,background:"#3B82F6",color:"#fff",fontSize:8,fontWeight:800,width:16,height:16,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",zIndex:2}},tc),
            React.createElement("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",gap:3}},React.createElement("span",{style:{width:8,height:8,borderRadius:"50%",background:trtClr[ps]}}),React.createElement("span",{style:{fontWeight:700,fontSize:12,color:ctx}},p.id)),React.createElement("div",{style:{fontSize:8,color:stx,marginTop:2}},lt?fD(lt.tdate):p.area))})))})))),
    React.createElement("div",{style:{background:cbg,borderRadius:10,padding:8,marginTop:8,border:"1px solid "+bd}},React.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:8}},
      [{l:"Sain",c:"#22C55E"},{l:"Trait√©",c:"#3B82F6"},{l:"√Ä surveiller",c:"#EAB308"},{l:"Besoin trt",c:"#EF4444"},{l:"DAR",c:"#F97316"}].map(x=>React.createElement("div",{key:x.l,style:{display:"flex",alignItems:"center",gap:3}},React.createElement("span",{style:{width:8,height:8,borderRadius:"50%",background:x.c}}),React.createElement("span",{style:{fontSize:9,color:stx}},x.l))))));
}

// ===== UNIFIED PARCEL MODAL =====
function ParcelModal({sec,sk,par,mode,observations,allObs,treatments,onClose,onAddObs,onDelObs,onTogObs,onAddTrt,onDelTrt,setMode,dark,cbg,ctx,stx,bd}){
  const[tab,setTab]=useState("list");
  const diseases=sec.type==="fraise"?DIS_F:DIS_M;
  const activeObs=observations.filter(r=>!r.res);
  const color=mode==="surv"?"#D97706":"#7C3AED";
  const gradient=mode==="surv"?"linear-gradient(135deg,#D97706,#F59E0B)":"linear-gradient(135deg,#7C3AED,#8B5CF6)";

  return React.createElement("div",{style:{position:"fixed",inset:0,zIndex:1000,animation:"fadeIn 0.2s"}},
    React.createElement("div",{onClick:onClose,style:{position:"absolute",inset:0,background:"rgba(0,0,0,0.6)",backdropFilter:"blur(4px)"}}),
    React.createElement("div",{style:{position:"absolute",bottom:0,left:0,right:0,maxHeight:"92vh",background:cbg,borderRadius:"20px 20px 0 0",overflow:"hidden",animation:"slideUp 0.3s",display:"flex",flexDirection:"column"}},
      React.createElement("div",{style:{background:gradient,padding:"14px 18px",flexShrink:0}},
        React.createElement("div",{style:{display:"flex",justifyContent:"space-between"}},
          React.createElement("div",null,React.createElement("h2",{style:{color:"#fff",fontSize:20,fontWeight:800,margin:0}},(mode==="surv"?"üîç ":"üíä ")+sec.name+" ‚Äî "+par.id),React.createElement("p",{style:{color:"rgba(255,255,255,0.85)",fontSize:12,margin:"2px 0 0"}},sec.fullName+" ‚Ä¢ "+par.area)),
          React.createElement("button",{onClick:onClose,style:{background:"rgba(255,255,255,0.2)",border:"none",color:"#fff",width:30,height:30,borderRadius:10,fontSize:16,cursor:"pointer"}},"‚úï")),
        React.createElement("div",{style:{display:"flex",gap:6,marginTop:8}},
          React.createElement("span",{style:{background:"rgba(255,255,255,0.2)",color:"#fff",padding:"3px 8px",borderRadius:8,fontSize:10,fontWeight:600}},activeObs.length+" cas actif"+(activeObs.length>1?"s":"")),
          React.createElement("span",{style:{background:"rgba(255,255,255,0.2)",color:"#fff",padding:"3px 8px",borderRadius:8,fontSize:10,fontWeight:600}},treatments.length+" trt"),
          React.createElement("button",{onClick:()=>{setMode(mode==="surv"?"trt":"surv");setTab("list")},style:{marginLeft:"auto",background:"rgba(255,255,255,0.25)",border:"none",color:"#fff",padding:"3px 10px",borderRadius:8,fontSize:10,fontWeight:600,cursor:"pointer"}},mode==="surv"?"üíä Traitements ‚Üí":"üîç Surveillance ‚Üí"))),
      // Tabs
      mode==="surv"?React.createElement("div",{style:{display:"flex",borderBottom:"1px solid "+bd,flexShrink:0}},
        [{k:"list",l:"ü¶† Observations ("+observations.length+")"},{k:"add",l:"‚ûï Observer"},{k:"history",l:"üìú Historique"}].map(t=>React.createElement("button",{key:t.k,onClick:()=>setTab(t.k),style:{flex:1,padding:10,border:"none",borderBottom:tab===t.k?"3px solid "+color:"3px solid transparent",background:tab===t.k?color+"11":"transparent",color:tab===t.k?color:stx,fontWeight:tab===t.k?700:500,fontSize:11,cursor:"pointer"}},t.l))):
      React.createElement("div",{style:{display:"flex",borderBottom:"1px solid "+bd,flexShrink:0}},
        [{k:"list",l:"üíä Traitements ("+treatments.length+")"},{k:"add",l:"‚ûï Traiter"},{k:"history",l:"üìú Historique"}].map(t=>React.createElement("button",{key:t.k,onClick:()=>setTab(t.k),style:{flex:1,padding:10,border:"none",borderBottom:tab===t.k?"3px solid "+color:"3px solid transparent",background:tab===t.k?color+"11":"transparent",color:tab===t.k?color:stx,fontWeight:tab===t.k?700:500,fontSize:11,cursor:"pointer"}},t.l))),
      // Content
      React.createElement("div",{style:{flex:1,overflow:"auto",padding:14}},
        // SURV LIST
        mode==="surv"&&tab==="list"&&(observations.length===0?React.createElement("div",{style:{textAlign:"center",padding:36,color:stx}},React.createElement("div",{style:{fontSize:44}},"‚úÖ"),React.createElement("p",{style:{fontWeight:600}},"Parcelle saine")):
          React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:8}},observations.map(r=>React.createElement(ObsCard,{key:r.id,r,treatments,sec,dark,cbg,ctx,stx,bd,onTog:onTogObs,onDel:onDelObs,showSection:false,compact:false})))),
        // SURV ADD
        mode==="surv"&&tab==="add"&&React.createElement(AddObsForm,{sk,pid:par.id,diseases,onSubmit:onAddObs,dark,cbg,ctx,stx,bd}),
        // TRT LIST
        mode==="trt"&&tab==="list"&&(treatments.length===0?React.createElement("div",{style:{textAlign:"center",padding:36,color:stx}},React.createElement("div",{style:{fontSize:44}},"üíä"),React.createElement("p",{style:{fontWeight:600}},"Aucun traitement")):
          React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:8}},treatments.map(r=>{const lo=observations.find(o=>o.id===r.obsId);const da=r.darEnd&&new Date(r.darEnd)>new Date();const dd=da?Math.ceil((new Date(r.darEnd)-new Date())/864e5):0;
            return React.createElement("div",{key:r.id,style:{background:dark?"#1A0028":"#F5F3FF",border:"1px solid "+(dark?"#3D1F6B":"#DDD6FE"),borderRadius:12,padding:12,borderLeft:"4px solid "+(da?"#F97316":"#7C3AED")}},
              React.createElement("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:4}},React.createElement("span",{style:{fontWeight:700,fontSize:14,color:dark?"#C4B5FD":"#6D28D9"}},r.prod),da&&React.createElement("span",{className:"blink",style:{fontSize:9,fontWeight:700,padding:"2px 8px",borderRadius:6,background:"#FFF7ED",color:"#C2410C",border:"1px solid #FB923C"}},"‚è≥ DAR: "+dd+"j")),
              React.createElement("div",{style:{fontSize:12,color:stx}},React.createElement("div",null,"üìè "+r.dose),React.createElement("div",null,"üìÖ "+fD(r.tdate)+" √† "+fH(r.at)),r.dar&&React.createElement("div",null,"‚è≥ DAR: "+r.dar+"j"+(r.darEnd?" ‚Üí fin "+fD(r.darEnd):"")),r.notes&&React.createElement("div",{style:{fontStyle:"italic",marginTop:2}},"üìù "+r.notes)),
              lo&&React.createElement("div",{style:{marginTop:6,padding:"6px 8px",background:dark?"#2A2000":"#FEF9C3",borderRadius:8,border:"1px solid "+(dark?"#5C4A00":"#FDE047")}},React.createElement("span",{style:{fontSize:10,fontWeight:600,color:"#92400E"}},"üîó "+lo.dis+" ("+lo.sev+")"+(lo.zone?" ‚Ä¢ "+lo.zone+"%":""))),
              React.createElement("div",{style:{display:"flex",gap:6,marginTop:8}},React.createElement("button",{onClick:()=>{if(confirm("Supprimer ?"))onDelTrt(r.id)},style:{padding:"7px 10px",borderRadius:8,border:"1px solid #FECACA",background:"#FEF2F2",fontSize:10,fontWeight:600,cursor:"pointer",color:"#DC2626"}},"üóëÔ∏è")))}))),
        // TRT ADD
        mode==="trt"&&tab==="add"&&React.createElement(AddTrtForm,{sk,pid:par.id,activeObs,onSubmit:onAddTrt,dark,cbg,ctx,stx,bd}),
        // HISTORY TAB
        tab==="history"&&React.createElement("div",null,
          React.createElement("h3",{style:{fontSize:14,fontWeight:700,marginBottom:10}},"üìú Historique complet ‚Äî "+sec.name+" "+par.id),
          observations.length===0&&treatments.length===0?React.createElement("div",{style:{textAlign:"center",padding:30,color:stx}},"Aucun historique"):
          React.createElement("div",{style:{position:"relative",paddingLeft:20}},
            React.createElement("div",{style:{position:"absolute",left:8,top:0,bottom:0,width:2,background:bd}}),
            [...observations.map(o=>({...o,_type:"obs",_time:new Date(o.at).getTime()})),...treatments.map(t=>({...t,_type:"trt",_time:new Date(t.at).getTime()}))].sort((a,b)=>b._time-a._time).map((item,i)=>
              React.createElement("div",{key:item.id,style:{position:"relative",marginBottom:12,paddingLeft:16}},
                React.createElement("div",{style:{position:"absolute",left:-14,top:4,width:12,height:12,borderRadius:"50%",background:item._type==="obs"?"#F59E0B":"#8B5CF6",border:"2px solid "+cbg,zIndex:2}}),
                React.createElement("div",{style:{fontSize:9,color:stx,marginBottom:3}},fDT(item.at)+" ‚Ä¢ "+(item._type==="obs"?"üîç Observation":"üíä Traitement")),
                item._type==="obs"?React.createElement(ObsCard,{r:item,treatments,sec,dark,cbg,ctx,stx,bd,showSection:false,compact:true}):
                React.createElement("div",{style:{background:dark?"#1A0028":"#F5F3FF",border:"1px solid "+(dark?"#3D1F6B":"#DDD6FE"),borderRadius:10,padding:10}},
                  React.createElement("div",{style:{fontWeight:700,fontSize:13,color:"#7C3AED"}},item.prod+" ‚Äî "+item.dose),
                  React.createElement("div",{style:{fontSize:11,color:stx}},"üìÖ "+fD(item.tdate)),
                  item.dar&&React.createElement("div",{style:{fontSize:10,color:"#EA580C"}},"‚è≥ DAR "+item.dar+"j")))))))));
}
function AddObsForm({sk,pid,diseases,onSubmit,dark,cbg,ctx,stx,bd}){
  const[dis,setDis]=useState("");const[cust,setCust]=useState("");const[sev,setSev]=useState("");const[date,setDate]=useState(new Date().toISOString().split("T")[0]);const[obsText,setObsText]=useState("");const[zone,setZone]=useState("");const[photos,setPhotos]=useState([]);
  const go=()=>{const d=dis==="__c"?cust:dis;if(!d||!sev){alert("Remplissez maladie et gravit√©");return}onSubmit({sk,pid,dis:d,sev,date,obsText,zone,photos,res:false});setDis("");setCust("");setSev("");setObsText("");setZone("");setPhotos([])};
  const is={width:"100%",padding:"11px 12px",borderRadius:10,border:"2px solid "+bd,fontSize:13,outline:"none",background:cbg,color:ctx};
  return React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:12}},
    React.createElement("h3",{style:{fontSize:15,fontWeight:700,margin:0}},"üîç Nouvelle observation"),
    React.createElement("div",null,React.createElement("label",{style:{display:"block",fontSize:11,fontWeight:600,color:stx,marginBottom:4}},"ü¶† Maladie *"),React.createElement("select",{value:dis,onChange:e=>setDis(e.target.value),style:{...is,cursor:"pointer"}},React.createElement("option",{value:""},"‚Äî S√©lectionner ‚Äî"),diseases.map(d=>React.createElement("option",{key:d,value:d},d)),React.createElement("option",{value:"__c"},"‚úèÔ∏è Autre")),dis==="__c"&&React.createElement("input",{value:cust,onChange:e=>setCust(e.target.value),placeholder:"Nom...",style:{...is,marginTop:6}})),
    React.createElement("div",null,React.createElement("label",{style:{display:"block",fontSize:11,fontWeight:600,color:stx,marginBottom:4}},"‚ö†Ô∏è Gravit√© *"),React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:6}},["Faible","Moyen","Grave"].map(s=>React.createElement("button",{key:s,onClick:()=>setSev(s),style:{padding:"10px 6px",borderRadius:10,border:"2px solid "+(sev===s?SC[s].border:bd),background:sev===s?SC[s].bg:cbg,color:sev===s?SC[s].text:stx,fontWeight:700,fontSize:12,cursor:"pointer"}},(s==="Faible"?"üü°":s==="Moyen"?"üü†":"üî¥")+" "+s)))),
    React.createElement("div",null,React.createElement("label",{style:{display:"block",fontSize:11,fontWeight:600,color:stx,marginBottom:4}},"üìÖ Date *"),React.createElement("input",{type:"date",value:date,onChange:e=>setDate(e.target.value),style:is})),
    React.createElement("div",null,React.createElement("label",{style:{display:"block",fontSize:11,fontWeight:600,color:stx,marginBottom:4}},"üìê Zone touch√©e (%)"),React.createElement("input",{type:"number",value:zone,onChange:e=>setZone(e.target.value),placeholder:"Ex: 30",min:0,max:100,style:is})),
    React.createElement("div",null,React.createElement("label",{style:{display:"block",fontSize:11,fontWeight:600,color:stx,marginBottom:4}},"üìù Observation visuelle"),React.createElement("textarea",{value:obsText,onChange:e=>setObsText(e.target.value),placeholder:"Sympt√¥mes observ√©s...",rows:3,style:{...is,resize:"vertical"}})),
    React.createElement("div",null,React.createElement("label",{style:{display:"block",fontSize:11,fontWeight:600,color:stx,marginBottom:4}},"üì∑ Photos"),React.createElement(PhotoCapture,{photos,setPhotos,dark,bd})),
    React.createElement("button",{onClick:go,style:{padding:13,borderRadius:12,border:"none",background:"linear-gradient(135deg,#D97706,#F59E0B)",color:"#fff",fontSize:14,fontWeight:700,cursor:"pointer"}},"üîç Enregistrer"));
}
function AddTrtForm({sk,pid,activeObs,onSubmit,dark,cbg,ctx,stx,bd}){
  const[obsId,setObsId]=useState("");const[prod,setProd]=useState("");const[dose,setDose]=useState("");const[tdate,setTdate]=useState(new Date().toISOString().split("T")[0]);const[dar,setDar]=useState("");const[notes,setNotes]=useState("");
  const darEnd=dar&&tdate?new Date(new Date(tdate).getTime()+parseInt(dar)*864e5).toISOString().split("T")[0]:"";
  const go=()=>{if(!prod||!dose){alert("Produit et dose requis");return}onSubmit({sk,pid,obsId:obsId||null,prod,dose,tdate,dar,darEnd,notes});setProd("");setDose("");setDar("");setNotes("");setObsId("")};
  const is={width:"100%",padding:"11px 12px",borderRadius:10,border:"2px solid "+bd,fontSize:13,outline:"none",background:cbg,color:ctx};
  return React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:12}},
    React.createElement("h3",{style:{fontSize:15,fontWeight:700,margin:0}},"üíä Nouveau traitement"),
    activeObs.length>0&&React.createElement("div",null,React.createElement("label",{style:{display:"block",fontSize:11,fontWeight:600,color:stx,marginBottom:4}},"üîó Lier √† une observation"),React.createElement("select",{value:obsId,onChange:e=>setObsId(e.target.value),style:{...is,cursor:"pointer"}},React.createElement("option",{value:""},"‚Äî Pr√©ventif ‚Äî"),activeObs.map(o=>React.createElement("option",{key:o.id,value:o.id},o.dis+" ("+o.sev+") ‚Äî "+fD(o.date))))),
    React.createElement("div",null,React.createElement("label",{style:{display:"block",fontSize:11,fontWeight:600,color:stx,marginBottom:4}},"üíä Produit *"),React.createElement("input",{value:prod,onChange:e=>setProd(e.target.value),placeholder:"Soufre, Switch...",style:is})),
    React.createElement("div",null,React.createElement("label",{style:{display:"block",fontSize:11,fontWeight:600,color:stx,marginBottom:4}},"üìè Dose *"),React.createElement("input",{value:dose,onChange:e=>setDose(e.target.value),placeholder:"5 kg/ha...",style:is})),
    React.createElement("div",null,React.createElement("label",{style:{display:"block",fontSize:11,fontWeight:600,color:stx,marginBottom:4}},"üìÖ Date *"),React.createElement("input",{type:"date",value:tdate,onChange:e=>setTdate(e.target.value),style:is})),
    React.createElement("div",null,React.createElement("label",{style:{display:"block",fontSize:11,fontWeight:600,color:stx,marginBottom:4}},"‚è≥ DAR (jours)"),React.createElement("input",{type:"number",value:dar,onChange:e=>setDar(e.target.value),placeholder:"7, 14...",min:0,style:is}),darEnd&&React.createElement("div",{style:{marginTop:4,fontSize:11,color:"#EA580C",fontWeight:600}},"‚ö†Ô∏è R√©colte d√®s "+fD(darEnd))),
    React.createElement("div",null,React.createElement("label",{style:{display:"block",fontSize:11,fontWeight:600,color:stx,marginBottom:4}},"üìù Notes"),React.createElement("textarea",{value:notes,onChange:e=>setNotes(e.target.value),placeholder:"Notes...",rows:2,style:{...is,resize:"vertical"}})),
    React.createElement("button",{onClick:go,style:{padding:13,borderRadius:12,border:"none",background:"linear-gradient(135deg,#7C3AED,#8B5CF6)",color:"#fff",fontSize:14,fontWeight:700,cursor:"pointer"}},"üíä Enregistrer"));
}

// VISUAL PLAN (unchanged)
function VisualPlan({bg,cbg,ctx,stx,bd,dark}){
  const[zoom,setZoom]=useState(1);
  const blocks=[{id:"Bureau",x:37,y:0,w:9,h:3.5,c:"#64748B",ic:"üè¢"},{id:"D.E",x:46,y:0,w:5,h:3.5,c:"#78716C",ic:"üì¶"},{id:"D.P",x:51,y:0,w:5,h:3.5,c:"#92400E",ic:"üß™"},{id:"M.S",x:56,y:0,w:5,h:3.5,c:"#78716C",ic:"üè™"},{id:"P1",x:61,y:0,w:4,h:3.5,c:"#0EA5E9",ic:"üíß"},{id:"E",x:66,y:1,w:3,h:3,c:"#6B7280",ic:"üö™"},{id:"V15\n0.68ha",x:20,y:2,w:6,h:5,c:"#3B82F6",sec:"AG1"},{id:"P3",x:26,y:2,w:3,h:2.5,c:"#0EA5E9",ic:"üíß"},{id:"V13\n0.66ha",x:29,y:2,w:6,h:5,c:"#3B82F6",sec:"AG1"},{id:"B1",x:35,y:5,w:4,h:3,c:"#0EA5E9",ic:"üíß"},{id:"B2",x:35,y:8.5,w:4,h:3,c:"#0EA5E9",ic:"üíß"},{id:"V16\n0.86ha",x:20,y:8,w:7,h:6,c:"#3B82F6",sec:"AG1"},{id:"V14\n0.74ha",x:27,y:8,w:7,h:6,c:"#3B82F6",sec:"AG1"},{id:"SF1",x:35,y:12,w:3.5,h:3,c:"#10B981",ic:"‚öôÔ∏è"},{id:"V18\n1.00ha",x:2,y:3,w:8,h:6,c:"#6366F1",sec:"AG2"},{id:"V17\n0.91ha",x:2,y:10,w:7,h:6,c:"#6366F1",sec:"AG2"},{id:"V19\n0.70ha",x:2,y:17,w:7,h:5.5,c:"#E11D48",sec:"AG5"},{id:"V6\n0.74ha",x:10,y:15,w:7,h:6,c:"#E11D48",sec:"AG5"},{id:"V9\n0.63ha",x:10,y:21.5,w:7,h:6,c:"#E11D48",sec:"AG5"},{id:"V5\n0.70ha",x:2,y:23,w:7,h:6,c:"#E11D48",sec:"AG5"},{id:"SF2",x:35,y:15.5,w:3.5,h:3,c:"#10B981",ic:"‚öôÔ∏è"},{id:"V10\n0.54ha",x:10,y:28,w:6,h:5,c:"#E11D48",sec:"AG5"},{id:"V11\n0.66ha",x:16,y:28,w:6,h:5,c:"#E11D48",sec:"AG5"},{id:"V1\n0.42ha",x:39,y:7,w:7,h:5.5,c:"#DC2626",sec:"AG4"},{id:"V2\n0.31ha",x:46,y:7,w:6,h:5.5,c:"#DC2626",sec:"AG4"},{id:"WC4",x:45,y:13,w:3,h:2.5,c:"#6B7280",ic:"üöª"},{id:"V4\n0.42ha",x:39,y:13.5,w:7,h:5.5,c:"#DC2626",sec:"AG4"},{id:"V12\n0.45ha",x:39,y:20,w:7,h:5.5,c:"#DC2626",sec:"AG4"},{id:"V7\n0.45ha",x:46,y:20,w:7,h:5.5,c:"#DC2626",sec:"AG4"},{id:"V13\n0.45ha",x:39,y:26,w:7,h:5.5,c:"#DC2626",sec:"AG4"},{id:"V15\n0.55ha",x:46,y:26,w:7,h:5.5,c:"#DC2626",sec:"AG4"},{id:"V20\n0.66ha",x:39,y:32.5,w:7,h:5.5,c:"#DC2626",sec:"AG4"},{id:"V19\n0.78ha",x:46,y:32.5,w:7,h:5.5,c:"#DC2626",sec:"AG4"},{id:"V21\n0.65ha",x:39,y:38.5,w:7,h:5.5,c:"#DC2626",sec:"AG4"},{id:"V18\n0.79ha",x:46,y:38.5,w:7,h:5.5,c:"#DC2626",sec:"AG4"},{id:"A",x:57,y:8,w:4,h:4,c:"#92400E",ic:"üîß"},{id:"P2",x:57,y:13,w:3.5,h:3,c:"#0EA5E9",ic:"üíß"},{id:"V3\n0.30ha",x:62,y:5,w:5,h:4.5,c:"#8B5CF6",sec:"AG3a"},{id:"V5\n0.21ha",x:55,y:13,w:4,h:3.5,c:"#8B5CF6",sec:"AG3a"},{id:"V12\n0.21ha",x:55,y:13,w:4,h:3.5,c:"#8B5CF6",sec:"AG3a"},{id:"V6\n0.39ha",x:67,y:5,w:5,h:4.5,c:"#8B5CF6",sec:"AG3a"},{id:"R",x:67,y:11,w:4,h:4,c:"#B45309",ic:"üçΩÔ∏è"},{id:"V8\n0.20ha",x:67,y:16,w:4,h:4.5,c:"#8B5CF6",sec:"AG3a"},{id:"V9\n0.30ha",x:71,y:16,w:4,h:4.5,c:"#8B5CF6",sec:"AG3a"},{id:"V11\n0.25ha",x:67,y:21.5,w:4,h:4.5,c:"#7C3AED",sec:"AG3b"},{id:"V10\n0.36ha",x:71,y:21.5,w:4,h:4.5,c:"#7C3AED",sec:"AG3b"},{id:"V16\n0.88ha",x:60,y:27,w:7,h:5.5,c:"#7C3AED",sec:"AG3b"},{id:"V17\n0.79ha",x:67,y:27,w:7,h:5.5,c:"#7C3AED",sec:"AG3b"},{id:"V1\n0.68ha",x:39,y:45,w:7,h:5.5,c:"#16A34A",sec:"S1"},{id:"V2\n0.37ha",x:46,y:45,w:6,h:5.5,c:"#16A34A",sec:"S1"},{id:"V3\n0.72ha",x:52,y:45,w:6,h:5.5,c:"#16A34A",sec:"S1"},{id:"V4\n0.80ha",x:39,y:51,w:7,h:5.5,c:"#16A34A",sec:"S1"},{id:"V5\n0.75ha",x:46,y:51,w:6,h:5.5,c:"#16A34A",sec:"S1"},{id:"V6\n0.29ha",x:52,y:51,w:5,h:5.5,c:"#16A34A",sec:"S1"},{id:"V7\n0.87ha",x:39,y:57,w:7,h:5.5,c:"#16A34A",sec:"S1"},{id:"V8\n0.76ha",x:46,y:57,w:6,h:5.5,c:"#16A34A",sec:"S1"},{id:"V9\n0.26ha",x:52,y:57,w:5,h:5.5,c:"#16A34A",sec:"S1"},{id:"V10\n0.77ha",x:30,y:64,w:8,h:5.5,c:"#059669",sec:"S2"},{id:"V11\n0.85ha",x:42,y:64,w:8,h:5.5,c:"#059669",sec:"S2"},{id:"V12\n0.66ha",x:18,y:70,w:6,h:5,c:"#059669",sec:"S2"},{id:"V14\n0.67ha",x:18,y:70,w:6,h:5,c:"#059669",sec:"S2"},{id:"V13\n1.52ha",x:24,y:70,w:12,h:5,c:"#059669",sec:"S2"},{id:"V16\n0.66ha",x:18,y:76,w:6,h:5,c:"#059669",sec:"S2"},{id:"V15\n1.50ha",x:24,y:76,w:12,h:5,c:"#059669",sec:"S2"},{id:"V18\n0.60ha",x:18,y:82,w:6,h:5,c:"#059669",sec:"S2"},{id:"V17\n1.50ha",x:24,y:82,w:12,h:5,c:"#059669",sec:"S2"},{id:"V20\n0.70ha",x:18,y:88,w:7,h:5.5,c:"#0D9488",sec:"S3"},{id:"V19\n1.00ha",x:25,y:88,w:10,h:5.5,c:"#0D9488",sec:"S3"},{id:"V31\n0.83ha",x:66,y:68,w:7,h:5.5,c:"#EA580C",sec:"AG6"},{id:"V32\n0.66ha",x:73,y:68,w:6,h:5.5,c:"#EA580C",sec:"AG6"},{id:"V34\n0.64ha",x:66,y:74,w:7,h:5.5,c:"#EA580C",sec:"AG6"},{id:"V33\n0.59ha",x:73,y:74,w:6,h:5.5,c:"#EA580C",sec:"AG6"},{id:"V35\n0.73ha",x:66,y:80,w:7,h:5.5,c:"#EA580C",sec:"AG6"},{id:"V36\n0.52ha",x:73,y:80,w:6,h:5.5,c:"#EA580C",sec:"AG6"}];
  const secLabels=[{t:"P-AG1 : 3.00 ha",x:20,y:0.5,c:"#3B82F6"},{t:"P-AG2 : 2.60 ha",x:2,y:1,c:"#6366F1"},{t:"P-AG5 : 2.70 ha",x:10,y:14,c:"#E11D48"},{t:"P-AG4 : 6 ha",x:39,y:31.5,c:"#DC2626"},{t:"P-AG3 : 1.80 ha",x:62,y:3,c:"#8B5CF6"},{t:"P-AG3 : 2.0 ha",x:67,y:20,c:"#7C3AED"},{t:"S1 : 5.50 ha",x:52,y:43,c:"#16A34A"},{t:"S2 : 6.6 ha",x:18,y:68,c:"#059669"},{t:"S3 : 3.8 ha",x:18,y:86.5,c:"#0D9488"},{t:"P-AG6 : 4.00 ha",x:66,y:66.5,c:"#EA580C"}];
  return React.createElement("div",null,
    React.createElement("h2",{style:{fontSize:16,fontWeight:800,margin:"0 0 10px"}},"üèóÔ∏è Plan Ferme Zaouia"),
    React.createElement("div",{style:{display:"flex",gap:4,marginBottom:8,justifyContent:"center"}},React.createElement("button",{onClick:()=>setZoom(z=>Math.max(0.5,z-0.2)),style:{width:34,height:34,borderRadius:8,border:"1px solid "+bd,background:cbg,fontSize:16,cursor:"pointer",color:ctx,fontWeight:700}},"‚àí"),React.createElement("span",{style:{padding:"8px 10px",fontSize:11,fontWeight:600,color:stx}},Math.round(zoom*100)+"%"),React.createElement("button",{onClick:()=>setZoom(z=>Math.min(3,z+0.2)),style:{width:34,height:34,borderRadius:8,border:"1px solid "+bd,background:cbg,fontSize:16,cursor:"pointer",color:ctx,fontWeight:700}},"+"),React.createElement("button",{onClick:()=>setZoom(1),style:{padding:"8px 10px",borderRadius:8,border:"1px solid "+bd,background:cbg,fontSize:10,cursor:"pointer",color:stx,fontWeight:600}},"Reset")),
    React.createElement("div",{style:{overflow:"auto",borderRadius:14,border:"2px solid "+bd,background:dark?"#0A1A0D":"#E8F5E9"}},React.createElement("div",{style:{position:"relative",width:Math.max(700,700*zoom),height:Math.max(680,680*zoom),padding:8}},
      React.createElement("div",{style:{position:"absolute",top:0,left:0,right:0,height:20*zoom,background:"linear-gradient(90deg,#2D6A4F,#40916C)",display:"flex",alignItems:"center",justifyContent:"center",borderRadius:"6px 6px 0 0",zIndex:10}},React.createElement("span",{style:{color:"#fff",fontWeight:800,fontSize:9*zoom,letterSpacing:1}},"PLAN FERME ZAOUIA ¬´ AGRO BERRY ¬ª")),
      secLabels.map((sl,i)=>React.createElement("div",{key:"sl"+i,style:{position:"absolute",left:sl.x*0.82*zoom+"%",top:(sl.y*0.82+3)*zoom+"%",fontSize:7*zoom,fontWeight:800,color:sl.c,whiteSpace:"nowrap",zIndex:8}},sl.t)),
      blocks.map((b,i)=>{const isSec=!!b.sec;const isInfra=!!b.ic;const lines=b.id.split("\n");return React.createElement("div",{key:"b"+i,style:{position:"absolute",left:b.x*0.82*zoom+"%",top:(b.y*0.82+3)*zoom+"%",width:b.w*0.82*zoom+"%",height:b.h*0.82*zoom+"%",background:isSec?(dark?b.c+"33":b.c+"22"):(dark?"#252525":"#F1F5F9"),border:"1.5px solid "+(isSec?b.c+"88":(dark?"#444":"#CBD5E1")),borderRadius:3*zoom,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",zIndex:5}},isInfra&&React.createElement("span",{style:{fontSize:8*zoom}},b.ic),lines.map((l,li)=>React.createElement("span",{key:li,style:{fontSize:(li===0?7.5:5.5)*zoom,fontWeight:li===0?700:500,color:isSec?b.c:(dark?"#9CA3AF":b.c||"#64748B"),lineHeight:1.2}},l)))}))),
    React.createElement("div",{style:{background:cbg,borderRadius:12,padding:12,marginTop:10,border:"1px solid "+bd}},React.createElement("h4",{style:{fontSize:12,fontWeight:700,marginBottom:8}},"L√©gende"),React.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(2,1fr)",gap:6,fontSize:10,color:stx}},["üíß Bassin/Puits","üß™ D√©p√¥t phyto","üì¶ D√©p√¥t engrais","‚öôÔ∏è Station fertigation","üè™ Magasin","üîß Atelier","üçΩÔ∏è R√©fectoire","üö™ Entr√©e"].map((l,i)=>React.createElement("span",{key:i},l))),React.createElement("div",{style:{marginTop:8,display:"grid",gridTemplateColumns:"repeat(2,1fr)",gap:4,fontSize:10}},
      [{n:"HLS",c:"#3B82F6"},{n:"Sol",c:"#DC2626"},{n:"Fraise",c:"#16A34A"},{n:"Infra",c:"#64748B"}].map((x,i)=>React.createElement("div",{key:i,style:{display:"flex",alignItems:"center",gap:4}},React.createElement("span",{style:{width:12,height:12,borderRadius:3,background:x.c+"33",border:"2px solid "+x.c}}),React.createElement("span",{style:{color:stx}},x.n))))));
}

// SETTINGS
function Settings({bg,cbg,ctx,stx,bd,dark,ghCfg,setGhCfg,sync,restore,syncSt,observations,treatments,setObs,setTrt,t}){
  const is={width:"100%",padding:"11px 12px",borderRadius:10,border:"2px solid "+bd,fontSize:13,outline:"none",background:cbg,color:ctx};
  const exp=()=>{const b=new Blob([JSON.stringify({observations,treatments,at:new Date().toISOString(),v:VER},null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download="agro-berry-"+new Date().toISOString().split("T")[0]+".json";a.click();t("Export√© ‚úì")};
  const imp=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(d.observations){setObs(d.observations);if(d.treatments)setTrt(d.treatments);t("Import√© ‚úì")}else t("Format invalide","err")}catch{t("Erreur","err")}};r.readAsText(f)};
  return React.createElement("div",null,
    React.createElement("h2",{style:{fontSize:16,fontWeight:800,margin:"0 0 14px"}},"‚öôÔ∏è Param√®tres"),
    React.createElement("div",{style:{background:cbg,borderRadius:12,padding:14,marginBottom:10,border:"1px solid "+bd}},React.createElement("h3",{style:{fontSize:14,fontWeight:700,margin:"0 0 10px"}},"üêô GitHub"),React.createElement("div",{style:{display:"flex",flexDirection:"column",gap:8}},React.createElement("input",{value:ghCfg.owner,onChange:e=>setGhCfg(p=>({...p,owner:e.target.value})),placeholder:"Username",style:is}),React.createElement("input",{value:ghCfg.repo,onChange:e=>setGhCfg(p=>({...p,repo:e.target.value})),placeholder:"Repo",style:is}),React.createElement("input",{type:"password",value:ghCfg.token,onChange:e=>setGhCfg(p=>({...p,token:e.target.value})),placeholder:"Token ghp_...",style:is}),React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6}},React.createElement("button",{onClick:sync,disabled:syncSt==="s",style:{padding:11,borderRadius:10,border:"none",background:syncSt==="s"?"#9CA3AF":"#2D6A4F",color:"#fff",fontSize:12,fontWeight:600,cursor:"pointer"}},syncSt==="s"?"‚è≥...":"‚òÅÔ∏è Sauvegarder"),React.createElement("button",{onClick:restore,disabled:syncSt==="s",style:{padding:11,borderRadius:10,border:"none",background:syncSt==="s"?"#9CA3AF":"#7C3AED",color:"#fff",fontSize:12,fontWeight:600,cursor:"pointer"}},syncSt==="s"?"‚è≥...":"üì• Restaurer")))),
    React.createElement("div",{style:{background:cbg,borderRadius:12,padding:14,marginBottom:10,border:"1px solid "+bd}},React.createElement("h3",{style:{fontSize:14,fontWeight:700,margin:"0 0 10px"}},"üíæ Export / Import"),React.createElement("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6}},React.createElement("button",{onClick:exp,style:{padding:11,borderRadius:10,border:"1px solid "+bd,background:cbg,color:ctx,fontSize:12,fontWeight:600,cursor:"pointer"}},"üì§ Exporter"),React.createElement("label",{style:{padding:11,borderRadius:10,border:"1px solid "+bd,background:cbg,color:ctx,fontSize:12,fontWeight:600,cursor:"pointer",textAlign:"center"}},"üì• Importer",React.createElement("input",{type:"file",accept:".json",onChange:imp,style:{display:"none"}})))),
    React.createElement("div",{style:{background:cbg,borderRadius:12,padding:14,marginBottom:10,border:"1px solid "+bd}},React.createElement("div",{style:{fontSize:12,color:stx}},React.createElement("div",null,"üîç Observations: "+observations.length),React.createElement("div",null,"üíä Traitements: "+treatments.length))),
    React.createElement("div",{style:{background:dark?"#2A0000":"#FEF2F2",borderRadius:12,padding:14,border:"1px solid "+(dark?"#5C0000":"#FECACA")}},React.createElement("button",{onClick:()=>{if(confirm("SUPPRIMER TOUT ?")){setObs([]);setTrt([])}},style:{width:"100%",padding:11,borderRadius:10,border:"1px solid #DC2626",background:"transparent",color:"#DC2626",fontSize:12,fontWeight:600,cursor:"pointer"}},"üóëÔ∏è Tout supprimer")),
    React.createElement("p",{style:{textAlign:"center",fontSize:10,color:stx,marginTop:14}},"Agro Berry v"+VER));
}

ReactDOM.render(React.createElement(App),document.getElementById("root"));
</script>
</body>
</html>
